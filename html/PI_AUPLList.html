
<meta charset="UTF-8">

<style>
    #table-list th {
        min-width: 70px;
    }
    #table-list th:nth-child(8) {
        min-width: 40px;
    }
</style>

<!-- 表顶 -->
<div class="accordion" id="accordion">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle external collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                <legend>
                    <i class="icon-chevron-down"></i>
                    <i class="icon-chevron-up"></i>
                    检索
                </legend>
            </a>
        </div>
        <div id="collapseOne" class="accordion-body collapse">
            <div class="accordion-inner">
                <form id="form-query" class="form-horizontal" method="post" action="modules/PI_ctl.jsp?action=TreatmentVary">
                    <div class="block">
                        <div class="control-group">
                            <label class="control-label">开始时间</label>
                            <div class="controls">
                                <input type="text" class="datepicker_c" name="DateBegin" maxlength="7">
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">结束时间</label>
                            <div class="controls">
                                <input type="text" class="datepicker_c" name="DateEnd" maxlength="7">
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">区域选择</label>
                            <div class="controls">
                                <select name="AREA">
                                    <option value="440700">市区</option>
                                    <option value="440703">蓬江</option>
                                    <option value="440704">江海</option>
                                    <option value="440705">新会</option>
                                    <option value="440781">台山</option>
                                    <option value="440783">开平</option>
                                    <option value="440784">鹤山</option>
                                    <option value="440785">恩平</option>
                                </select>
                            </div>
                        </div>
                        <div class="control-group">
                            <input type="hidden" name="page" value="1">
                            <input type="submit" value="提交" class="btn btn-primary">
                            <input type="reset" value="重置" class="btn">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- /表顶 -->

<!-- 表格 -->
<table id="table-list">
    <caption>
        <i class="icon-th-list"></i>养老金月支付变化列表
    </caption>
    <thead>
        <tr>
            <th>统计年月</th>
            <th>当月人数</th>
            <th>上月人数</th>
            <th>人数变化</th>
            <th>当月金额</th>
            <th>上月金额</th>
            <th>金额变化</th>
        </tr>
    </thead>

    <tbody>
        <tr>
            <td class="td-sole" colspan="7">没有记录</td>
        </tr>
    </tbody>

    <!-- 表底 -->
    <tfoot>
        <tr>
            <td colspan="7">
                <div class="pagination"></div>
            </td>
        </tr>
    </tfoot>
    <!-- /表底 -->
</table>
<!-- /表格 -->


<script>
    var $form_query = $frame.find('#form-query'),
            $table_list = $('#table-list'),
            $tbody = $table_list.find('tbody'),
            $pagination = $table_list.find('.pagination');

    $frame.find('.datepicker_c').datepicker({
        "changeYear" : true,
        "changeMonth": true,
        "dateFormat" : 'yy-mm'
    });

    // 检索
    $form_query.ajaxForm({
        success: function(data) {
            var resObj = {};
            try {
                resObj = _.isObject(data) ? data : $.parseJSON(data);
            } catch (err) {}
            var msg = resObj['__MESSAGE__'];
            msg && alert(msg);
            // 表格数据
            showTable(resObj);
        }
    });

    // 开始的时候自动提交
    var now = new Date();
    now.setDate(15); // 确保减去一个月后的月份准确性
    var oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    $form_query.find('[name="DateBegin"]').val(oneMonthAgo.toJSON().slice(0, 7));
    $form_query.find('[name="DateEnd"]').val(now.toJSON().slice(0, 7));
    $form_query.submit();

    function getPage(n) {
        $.get('modules/PI_ctl.jsp?action=TreatmentVary', {
            'Page': n
        }, function(resObj) {
            if (! _.isObject(resObj)) resObj = $.parseJSON(resObj);
            showTable(resObj);
        });
    }
    function showTable(resObj) {

        // 测试数据
        var fakePageList = [];
        _.times(_.random(5, 10), function(i) {
            fakePageList.push({
                'STATISTICMONTH': '2013-10',
                'CURRENTPEOPLE': _.random(10, 100),
                'LASTPEOPLE': _.random(10, 100),
                'PEOPLECHAGE': _.random(5, 50),
                'CURRENTMONEY': _.random(10, 100),
                'LASTMONEY': _.random(1000, 10000),
                'MONEYCHANGE': _.random(500, 5000)
            });
            resObj = {
                '_curPage': 1,
                '_pageCount': 1,
                '_PageList': fakePageList
            }
        });

        $table_list.addClass('hidden');
        var pageList = resObj['_PageList'];
        if (pageList.length < 1) {
            $tbody.html([
                '<tr>',
                    '<td class="td-sole" colspan="7">没有记录</td>',
                '</tr>'
            ].join(''));
        } else {
            var tbodyHtml = _.reduce(pageList, function(memo, item, i) {
                return memo + [
                    '<tr>',
                        '<td>'+ item['STATISTICMONTH'] +'</td>',
                        '<td>'+ item['CURRENTPEOPLE'] +'</td>',
                        '<td>'+ item['LASTPEOPLE'] +'</td>',
                        '<td>'+ item['PEOPLECHAGE'] +'</td>',
                        '<td>'+ item['CURRENTMONEY'] +'</td>',
                        '<td>'+ item['LASTMONEY'] +'</td>',
                        '<td>'+ item['MONEYCHANGE'] +'</td>',
                    '</tr>'
                ].join('');
            }, '');
            $tbody.html(tbodyHtml);
        }
        // 分页
        $pagination.html([
            '<span><a onclick="getPage(1)">首页</a></span>',
            '<span><a onclick="getPage('+ Math.max((resObj['_curPage'] - 1), 1) +')">上一页</a></span>',
            '<span>当前页'+ resObj['_curPage'] +'/'+ resObj['_pageCount'] +'</span>',
            '<span><a onclick="getPage('+ Math.min((resObj['_curPage'] + 1), resObj['_pageCount']) +')">下一页</a></span>',
            '<span><a onclick="getPage('+ resObj['_pageCount'] +')">尾页</a></span>'
        ].join(''));
        $table_list.removeClass('hidden');
    }
</script>