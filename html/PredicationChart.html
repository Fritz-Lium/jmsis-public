<meta charset="UTF-8">

<style>
	.ui-datepicker-calendar {
		display: none;
	}
	.ui-datepicker-month {
		display: none;
	}
</style>

<script>
	var $oldDialogs = $body.children('[role="dialog"]');
	[].forEach.call($oldDialogs, function(el){
		el.parentNode.removeChild(el);
	})
</script>

<div class="accordion" id="accordion2">
  <div class="accordion-group">
	<div class="accordion-heading">
	  <a class="accordion-toggle external collapsed" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
		<legend>
			<i class="icon-chevron-down"></i>
			<i class="icon-chevron-up"></i>
			信息过滤
		</legend>
	  </a>
	</div>
	<div id="collapseOne" class="accordion-body collapse">
	  <div class="accordion-inner">
		<form class="form-horizontal" method="post" action="modules/ PI_ctl.jsp?action=ExpensesPredication">
			<div class="block">
				<div class="control-group">
					<label class="control-label">开始年份</label>
					<div class="controls">
						<input type="text" class="datepicker_c" name="KSNF"/>
					</div>
				</div>
				<div class="control-group">
					<label class="control-label">结束年份</label>
					<div class="controls">
						<input type="text" class="datepicker_c" name="JSNF"/>
					</div>
				</div>
				<div class="control-group">
					<input type="submit" value="提交" class="btn btn-primary"/>
					<input type="reset" value="重置" class="btn"/>
				</div>
			</div>
		</form>
	  </div>
	</div>
  </div>
</div>




<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

<div id="pre_redAlert" class="dialog_c" title="警告！">
	<p>余额不足3个月！</p>
</div>
<div id="pre_yellowAlert" class="dialog_c" title="警告！">
	<p>余额不足半年！</p>
</div>

<script>
	var myDate = new Date();
	$('[name="KSNF"]').val(myDate.getFullYear() - 3);
	$('[name="JSNF"]').val(myDate.getFullYear() + 2);

	$(".datepicker_c").datepicker({
		changeMonth: true,
		changeYear: true,
		showButtonPanel: true,
		dateFormat: 'yy',
		onClose: function(dateText, inst) {
			var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
			var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
			$(this).datepicker('setDate', new Date(year, month));
		}
	});
	$('.datepicker_c').on('click', function(){
		$(this).datepicker('setDate', new Date($(this).val()));
	});


	$( ".dialog_c" ).dialog({
		autoOpen: false,
		show: {
			effect: "blind",
			duration: 500
		},
		hide: {
			effect: "blind",
			duration: 500
		},
		modal: true,
		buttons: {
			确定: function() {
				$( this ).dialog( "close" );
			}
		},
		resizable: false,
		draggable: false
	});
</script>

<script>
	function makeAdapt(years) {
		if(years.length > 12) {
			var len = years.length;
			var delta = parseInt(len / 12);
			var yearsAfter = new Array();
			for(var i=0; i < len; i++) {
				if(i % delta == 0)
					yearsAfter.push(years[i]);
				else
					yearsAfter.push("");
			}
			return yearsAfter;
		} else {
			return years;
		}
	}
</script>

<script>
function makeChart(htmlStr) {
	var resObj = JSON.parse(htmlStr);
	if(resObj) {
		var years = resObj['YEARS'];
		var division = resObj['DIVISION'];
		var income = resObj['INCOME'];
		var payout = resObj['PAYOUT'];
		var balance = resObj['BALANCE'];
		var yellow = parseInt(resObj['YELLOW']);
		var red = parseInt(resObj['RED']);
		var period = resObj['PERIOD'];
		var area = resObj['AREA'];
		var isYellow = false;
		var isRed = false;

		var incomeArr = new Array();
		var payoutArr = new Array();
		var balanceArr = new Array();
		var yellowLine = new Array();
		var redLine = new Array();
		for(var i=0; i < years.length; i++) {
			incomeArr.push(parseInt(income[i]));
			payoutArr.push(parseInt(payout[i]));
			balanceArr.push(parseInt(balance[i]));
			yellowLine.push(yellow);
			redLine.push(red);
			if(balanceArr[i] < red) {
				isRed = true;
				continue;
			}
			if(balanceArr[i] < yellow) {
				isYellow = true;
			}
		}

		years = makeAdapt(years);

		$('#container').highcharts({
			exporting: false,
			chart: {

			},
			title: {
				text: area
			},
			subtitle: {
				text: period
			}
			,
			xAxis: {
				categories: years
			},
			yAxis: {
				title: {
					text: '单位(' + division + ')'
				}
			},
			tooltip: {
				shared: true
			},
			series: [{
				name: '年收入',
				data: incomeArr,
				type: 'line',
				tooltip: {
					valueSuffix: division
				}
			}, {
				name: '年支出',
				data: payoutArr,
				type: 'line',
				tooltip: {
					valueSuffix: division
				}
			}, {
				name: '余额累计',
				data: balanceArr,
				type: 'line',
				tooltip: {
					valueSuffix: division
				}
			}, {
				name: '黄色警戒区域上限',
				data: yellowLine,
				type: 'areaspline',
				color: '#FFF68F',
				tooltip: {
					valueSuffix: division
				}
			}, {
				name: '红色警戒区域上限',
				data: redLine,
				type: 'areaspline',
				color: '#FF4500',
				tooltip: {
					valueSuffix: division
				}
			}]
		});
	} else {
		alert('no data');
	}
	if(isYellow) $('#pre_yellowAlert').dialog('open');
	if(isRed) $('#pre_redAlert').dialog('open');
}
</script>

<script>
/*
	$.ajax({
		url : 'modules/PI_ctl.jsp?action=ExpensesPredication',
		success : function(htmlStr) {
			makeChart(htmlStr);
		}
	});
*/
	var	htmlStr = '{"AREA":"市区直属","INCOME":["1000","1500","1300","1250","1400","1500"],"PAYOUT":["600","550","450","700","650","550"],"BALANCE":["400","950","850","550","750","950"],"__MESSAGE__":"","__NEXTACTION__":"","YEARS":["2010","2011","2012","2013","2014","2015"],"__ERROR__":false,"__CURRENTUSER__":"admin","TYPE":"个人帐户","__LOGINED__":true,"PERIOD":"2012年10月——2013年9月","DIVISION":"万元","YELLOW":"550","RED":"300"}';
	makeChart(htmlStr);
</script>

<script>
	var $form = $frame.find('form');
	$form.ajaxForm({
		beforeSend: function(){
			var ksyf = $form.find('[name="KSNF"]').val();
			var jsyf = $form.find('[name="JSNF"]').val();
			if(ksyf == "" || jsyf == "") {
				alert("开始月份和结束月份均不能为空");
				return false;
			}
		},
		success: function(resTxt) {
			makeChart(resTxt);
			$(".collapse").collapse('hide');
		}
	});
</script>
